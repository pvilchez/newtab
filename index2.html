<html>

<head>
<title>New Tab!</title>
<link id="themecss" rel="stylesheet" href="test2.css"/>

</head>

<body> 
  <div id="left-sidebar"> 
    <div id="left-sidebar-border"></div> 
    <div id="left-sidebar-content"> 
      
 
      <ul id="dot-list"> 
        <li class="dot" tabindex="0" role="button"><img src="f_logo.png" class="logo"></img><span></span></li> 
        <li class="dot" tabindex="0" role="button"><img src="y_logo.png" class="logo"></img><span></span></li>
        <li class="dot" tabindex="0" role="button"><img src="r_logo.png" class="logo"></img><span></span></li> 
        <li class="dot" tabindex="0" role="button"><img src="m_logo.png" class="logo"></img><span></span></li> 
        <li class="dot" tabindex="0" role="button"><img src="fcd_logo.png" class="logo"></img><span></span></li> 
        <li class="dot" tabindex="0" role="button"><img src="t_logo.png" class="logo"></img><span></span></li> 
      </ul> 
     
    </div> 
  </div>
  <div id="footer">
  	<div id="footer-border"></div> 
    <div id="footer-content">
    <button id="recently-closed-menu-button"> 
        <span i18n-content="recentlyclosed">Recently closed</span> 
        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAJCAYAAADgkQYQAAAAAXNSR0IArs4c6QAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB9oIGRQbOY8MjgMAAAA8SURBVBjTY2BAAzdv3vwPBAzImAGbInSFWBU9f/4cRSFWRb9+/UJRiFMRTOGNGzf+k28SUW4iynfo4QQAj22WmutXxVsAAAAASUVORK5CYII="> 
      </button> 
    </div>
    </div>
  </div>
  <div id="content">
  	<div id="center">
  	<ul id="todoItems">
  	</ul>
  	<input type="text" id="todo" name="todo" placeholder="What do you need to do?" style="width: 200px;" onkeypress="keyPress(event);">
  	<input type="submit" id="submit" value="Add Item" onclick="addTodo(); return false;">
  	</div>
  </div> 
</body> 
<script>
function keyPress(e){
	if (window.event) { e = window.event; }
    if (e.keyCode == 13){document.getElementById('submit').click();}
}

var app = {};
app.indexedDB = {};

app.indexedDB.db = null;

app.indexedDB.open = function() {
	var request = webkitIndexedDB.open("list", "db description.");
	
	request.onsuccess = function(e) {
		var v = "1.0";
		app.indexedDB.db = e.target.result;
		var db = app.indexedDB.db;
		
		if(v!=db.version) {
			var setVrequest = db.setVersion(v);
			
			setVrequest.onfailure = app.indexedDB.onerror;
			setVrequest.onsuccess = function(e) {
				var store = db.createObjectStore("todo", {keyPath: "timeStamp"});
				
				app.indexedDB.getAllTodoItems();
			};
		}
		app.indexedDB.getAllTodoItems();
	};
	request.onfailure = app.indexedDB.onerror;
}

app.indexedDB.addTodo = function(todoText) {
	var db = app.indexedDB.db;
	var trans = db.transaction(["todo"], webkitIDBTransaction.READ_WRITE, 0);
	var store = trans.objectStore("todo");
	var request = store.put({
		"text": todoText,
		"timeStamp" : new Date().getTime()
	});
	
	request.onsuccess = function(e) {
		app.indexedDB.getAllTodoItems();
	};
	
	request.onerror = function(e) {
		console.log("Add Error: ", e.value);
	};
};

app.indexedDB.getAllTodoItems = function() {
	var todos = document.getElementById("todoItems");
	todos.innerHTML = "";
	
	var db = app.indexedDB.db;
	var trans = db.transaction(["todo"], webkitIDBTransaction.READ_WRITE, 0);
	var store = trans.objectStore("todo");
	
	var keyRange = webkitIDBKeyRange.lowerBound(0);
	var cursorRequest = store.openCursor(keyRange);
	
	cursorRequest.onsuccess = function(e) {
		var result = e.target.result;
		if(!!result == false)
			return;
			
		renderTodo(result.value);
		result.continue();
	};
	
	cursorRequest.onerror = app.indexedDB.onerror;
};

function renderTodo(row) {
	var todos = document.getElementById("todoItems");
	var li = document.createElement("li");
	var a = document.createElement("a");
	var t = document.createTextNode(row.text);
	t.data = row.text;
	
	a.addEventListener("click", function() {
		app.indexedDB.deleteTodo(row.timeStamp);
	}, false);
	
	a.textContent = "[x] ";
	
	li.appendChild(a);
	li.appendChild(t);
	todos.appendChild(li);
}

app.indexedDB.deleteTodo = function(id) {
	var db = app.indexedDB.db;
	var trans = db.transaction(["todo"], webkitIDBTransaction.READ_WRITE, 0);
	var store = trans.objectStore("todo");
	
	var request = store.delete(id);
	
	request.onsuccess = function(e) {
    	app.indexedDB.getAllTodoItems();  // Refresh the screen
  	};

  	request.onerror = function(e) {
    	console.log("Delete Error: ", e);
  	};
};

function addTodo(){
	var todo = document.getElementById('todo');
	app.indexedDB.addTodo(todo.value);
	todo.value = '';
}

function init(){
	app.indexedDB.open();
}

window.addEventListener("DOMContentLoaded", init(), false);
	
</script>
</html>